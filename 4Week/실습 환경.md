![[Pasted image 20250803202448.png]]

- 기본 배포 가상 머신 : k8s-ctr, k8s-w1, k8s-w0, router
- router : 192.168.10.0/24 ↔ 192.168.20.0/24 대역 라우팅 역할, k8s 에 join 되지 않은 서버, loop1/loop2 dump 인터페이스 배치
- k8s-w0 : k8s-ctr/w1 노드와 다른 네트워크 대역에 배치
- 실습 동작에 필요한 static routing 설정 됨 with vagrant script file
- Cilium CNI v1.18 설치 상태로 배포 완료됨 - [Release](https://github.com/cilium/cilium/releases/tag/v1.18.0) , [KrLink](https://gitlab.com/ycheol76/cilium-study/-/blob/main/3nd-week/000.%20cilium%201.18.0%20values.yaml%20%EB%B3%80%EA%B2%BD%EC%82%AC%ED%95%AD%20%EC%A0%95%EB%A6%AC.md) ← 박용철님이 한글로 정리해주셨습니다
    - Minimum Linux Requirements: The minimum kernel version for this release series is Linux v5.10 or similar, such as RHEL 8.6
    - Scale Test Results: Cilium implements policies and services up to 45% faster in higher scale environments
        - Scale Test : 버전 마다 1000개 노드(‘3만개 파드 or 2.5개 Service / 40만개 백엔드)에서 성능 테스트 - [Link](https://github.com/cilium/cilium/pull/40227)
    - Image Size Reduction: Docker image sizes are reduced by 32% on arm64 architecture images
    - CRD Promotion to Stable: Promote CiliumCIDRGroup, CiliumLoadBalancerIPPool and all BGP CRDs to stable AP
    - Multi-Pool Tunnel Routing: Add support for tunnel routing in multi-pool IPAM mode
    - Policy Names in Hubble-CLI: Show the names of (C)CNPs that allowed or denied traffic when monitoring flows in Hubble
    - Encapsulated Traffic Decoding: Hubble decodes encapsulated traffic for deeper introspection into traffic flows
    - Route Aggregation: Add support for BGP route aggregation in the control plane
- 조하은님이 Cilium CNI v1.18 달라진점을 상세히 정리해주셨습니다 - [Blog](https://nuguni.tistory.com/122)


# File 참조

# 실습 환경 배포 후, 기본 접속 정보 확인
[k8s-ctr] 접속 후 기본 정보 확인

```bash
# k9s 설치되어 있음
CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_${CLI_ARCH}.deb -O /tmp/k9s_linux_${CLI_ARCH}.deb
apt install /tmp/k9s_linux_${CLI_ARCH}.deb
k9s # node/pod 정보 확인 - metrics-server 설치되어 있어서, cpu/mem 확인 가능


#
cat /etc/hosts
sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@k8s-w0 hostname
sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@k8s-w1 hostname
sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@router hostname

# 클러스터 정보 확인
kubectl cluster-info
kubectl cluster-info dump | grep -m 2 -E "cluster-cidr|service-cluster-ip-range"
                           
kubectl describe cm -n kube-system kubeadm-config
kubectl describe cm -n kube-system kubelet-config

# 노드 정보 : 상태, INTERNAL-IP 확인
ifconfig | grep -iEA1 'eth[0-9]:'
kubectl get node -owide

# 파드 정보 : 상태, 파드 IP 확인
kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'
kubectl get ciliumnode -o json | grep podCIDRs -A2
kubectl get pod -A -owide
kubectl get ciliumendpoints -A

# ipam 모드 확인
cilium config view | grep ^ipam

# iptables 확인
iptables-save
iptables -t nat -S
iptables -t filter -S
iptables -t mangle -S
iptables -t raw -S
```

[k8s-ctr] cilium 설치 정보 확인
```bash
# cilium 상태 확인
kubectl get cm -n kube-system cilium-config -o json | jq
cilium status
cilium config view

#
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg status --verbose
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg metrics list

# monitor
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v -v

## Filter for only the events related to endpoint
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor --related-to=<id>

## Show notifications only for dropped packet events
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor --type drop

## Don’t dissect packet payload, display payload in hex information
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v -v --hex

## Layer7
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v --type l7
```

# 네트워크 정보 확인 : autoDirectNodeRoutes=true 동작 이해
```bash 
# router 네트워크 인터페이스 정보 확인
sshpass -p 'vagrant' ssh vagrant@router ip -br -c -4 addr
lo               UNKNOWN        127.0.0.1/8 
eth0             UP             10.0.2.15/24 metric 100 
eth1             UP             192.168.10.200/24 
eth2             UP             192.168.20.200/24 
loop1            UNKNOWN        10.10.1.200/24 
loop2            UNKNOWN        10.10.2.200/24

# k8s node 네트워크 인터페이스 정보 확인
ip -c -4 addr show dev eth1
sshpass -p 'vagrant' ssh vagrant@k8s-w1 ip -c -4 addr show dev eth1
sshpass -p 'vagrant' ssh vagrant@k8s-w0 ip -c -4 addr show dev eth1


# 라우팅 정보 확인
sshpass -p 'vagrant' ssh vagrant@router ip -c route
ip -c route | grep static

## --set routingMode=native --set autoDirectNodeRoutes=true 동작을 정확히 이해해보자!
ip -c route
sshpass -p 'vagrant' ssh vagrant@k8s-w1 ip -c route
sshpass -p 'vagrant' ssh vagrant@k8s-w0 ip -c route


# 통신 확인
ping -c 1 10.10.1.200     # router loop1 
ping -c 1 192.168.20.100  # k8s-w0 eth1

# 목적지까지 경우하는 라우팅 정보 제공
## Path MTU (pmtu): 출발지에서 목적지까지 모든 네트워크 경로 상에서 통과할 수 있는 최대 패킷 크기(Byte), IP fragmentation 없이 전송 가능한 가장 큰 패킷 크기를 의미.
## pmtu 1500: 전체 경로의 최소 MTU는 1500 , hops 2: 총 2단계 라우터/노드를 거쳐서 도달 , back 2: 응답도 동일한 hop 수로 돌아옴 
tracepath -n 192.168.20.100
 1?: [LOCALHOST]                      pmtu 1500
 1:  192.168.10.200                                        1.222ms 
 1:  192.168.10.200                                        0.980ms 
 2:  192.168.20.100                                        1.620ms reached
     Resume: pmtu 1500 hops 2 back 2 
```

# 도전과제0 Cilium 1.17.6 버전을 배포 후 Live 상태에서 Cilium 1.18.0 업그레이드 및 고려사항 정리 - [Docs](https://docs.cilium.io/en/stable/operations/upgrade/)

^abd0f4

- 박용철님이 공식 문서 Cilium 업그레이드 가이드 내용을 한글로 정리해주셨습니다 - [Link](https://gitlab.com/ycheol76/cilium-study/-/blob/main/3nd-week/000.%20v1.18.0%20%EC%97%85%EA%B7%B8%EB%A0%88%EC%9D%B4%EB%93%9C%20%EA%B0%80%EC%9D%B4%EB%93%9C.md)
